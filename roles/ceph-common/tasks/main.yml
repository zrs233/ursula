---
- include: checks/check_system.yml

- include: checks/check_mandatory_vars.yml

- name: install dependencies
  apt: pkg={{ item }}
       state=present
       update_cache=yes
       cache_valid_time=3600
  with_items: ceph_common.debian_pkgs

- name: install the ceph repository stable key
  apt_key: url={{ ceph_common.ceph_stable_key }}
           state=present
  when: ceph_common.ceph_stable

- name: add ceph stable repository
  apt_repository: repo="deb http://ceph.com/debian-{{ ceph_common.ceph_stable_release }}/ {{ ansible_lsb.codename }} main"
                  state=present
  when: ceph_common.ceph_stable

- name: install ceph
  apt: pkg={{ item }}
       state=present
  with_items: ceph_common.ceph_pkgs

- name: configure rbd clients directories
  file: path={{ item }}
        state=directory
        owner=libvirt-qemu
        group=kvm
        mode=0755
  with_items: ceph_common.rbd_client_paths
  when: ceph_common.rbd_client_directories

- name: check for a ceph socket
  stat: path=/var/run/ceph/*.asok
  changed_when: false
  failed_when: false
  register: socket

- name: generate ceph configuration file
  template: src=ceph.conf.j2
            dest=/etc/ceph/ceph.conf
            owner=root
            group=root
            mode=0644
  notify:
    - restart ceph mons
    - restart ceph osds

- name: create rbd client directory
  file: path={{ ceph_common.rbd_client_admin_socket_path }}
        state=directory
        owner=root
        group=root
        mode=0644
