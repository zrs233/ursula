---
- name: install dependencies
  apt: pkg=parted
       state=present

- name: write out bootstrap keyring
  copy:
    dest: "{{ hostvars[groups['mons'][0]]['keyrings']['source'] }}"
    content: "{{ hostvars[groups['mons'][0]]['keyrings']['content'] | b64decode }}"

- name: check if the device is a partition or a disk
  shell: "echo '{{ item }}' | egrep '/dev/(([a-z]{3,4}[0-9]$)|(cciss/c[0-9]{1}d[0-9]{1}p[0-9]$))'"
  with_items: ceph_osd.devices
  changed_when: false
  failed_when: false
  register: ispartition

- name: if partition named 'ceph' exists
  shell: "parted --script {{ item }} print | egrep -sq '^ 1.*ceph'"
  with_items: ceph_osd.devices
  changed_when: false
  failed_when: false
  register: parted

- name: erasing partitions and labels from osd disk(s)
  command: ceph-disk zap {{ item.2 }}
  changed_when: false
  with_together:
    - parted.results
    - ispartition.results
    - ceph_osd.devices
  when:
    item.0.rc != 0 and
    item.1.rc != 0 and
    ceph_osd.zap_devices

- name: erasing partitions and labels from the journal device(s)
  command: ceph-disk zap {{ item.2 }}
  changed_when: false
  with_together:
    - parted.results
    - ispartition.results
    - ceph_osd.raw_journal_devices
  when:
    item.0.rc != 0 and
    item.1.rc != 0 and
    ceph_osd.zap_devices

- name: prepare osd disk(s)
  command: "ceph-disk prepare {{ item.2 }} {{ item.3 }}"
  with_together:
    - parted.results
    - ispartition.results
    - ceph_osd.devices
    - ceph_osd.raw_journal_devices
  changed_when: false
  failed_when: false
  when:
    item.0.rc != 0 and
    item.1.rc != 0

# NOTE: this task is for disk devices only because of the explicit use of the first partition.
- name: activate osd(s) when device is a disk
  command: |
    ceph-disk activate {{ item.2 | regex_replace('^(\/dev\/cciss\/c[0-9]{1}d[0-9]{1})$', '\\1p') }}1
  with_together:
    - parted.results
    - ispartition.results
    - ceph_osd.devices
  failed_when: false
  when: item.0.rc == 0 and
        item.1.rc != 0

# NOTE: this task is for partitions because we don't explicitly use a partition.
- name: activate osd(s) when device is a partition
  command: "ceph-disk activate {{ item.1 }}"
  with_together:
    - ispartition.results
    - ceph_osd.devices
  failed_when: false
  when: item.0.rc == 0

- name: start and add that the osd service(s) to the init sequence
  service: name=ceph
           state=started
           enabled=yes
